# PDF Proxy Setup Guide

## Overview

The PDF proxy feature securely displays resume PDFs generated by the backend service without exposing the API key to the client. This is achieved through a Next.js API route that acts as a secure proxy.

## Architecture

```
┌─────────────┐         ┌──────────────┐         ┌─────────────────┐
│   Browser   │ ────▶   │  Next.js API │ ────▶   │ Backend Service │
│  (Client)   │         │  Proxy Route │         │  (PDF Service)  │
└─────────────┘         └──────────────┘         └─────────────────┘
  No API Key          Adds API Key             Validates API Key
```

### Flow:
1. **Client** requests: `/api/proxy-pdf?fileId=XXX`
2. **Proxy Route** appends private API key and fetches from backend
3. **Backend** validates API key and returns PDF
4. **Proxy** streams PDF back to client

## Setup Instructions

### 1. Environment Variables

Create a `.env.local` file in the frontend root directory:

```bash
# REQUIRED: PDF Service API Key (Keep this secret!)
PDF_SERVICE_API_KEY=your_actual_api_key_here

# OPTIONAL: Backend URL (defaults to http://localhost:8080)
BACKEND_API_URL=http://localhost:8080
```

**Important Security Notes:**
- ✅ **DO NOT** prefix with `NEXT_PUBLIC_` - this keeps it server-side only
- ✅ **DO NOT** commit `.env.local` to version control
- ✅ **DO** add `.env.local` to your `.gitignore` file
- ✅ **DO** use different API keys for development and production

### 2. Verify Setup

After setting up the environment variables, restart your Next.js development server:

```bash
npm run dev
```

The API key will be loaded when the server starts.

### 3. Testing

To test the PDF proxy:

1. Generate a resume in the bulk apply modal
2. The PDF should display in the iframe viewer
3. Check the browser DevTools Network tab - you should see requests to `/api/proxy-pdf?fileId=XXX`
4. Verify that the API key is **NOT** visible in the network request

### 4. Production Deployment

When deploying to production (Vercel, Netlify, etc.):

1. Add the `PDF_SERVICE_API_KEY` environment variable in your hosting platform's dashboard
2. Ensure `BACKEND_API_URL` points to your production backend
3. **Never** commit the actual API key to your repository

#### Example: Vercel Deployment

1. Go to your Vercel project settings
2. Navigate to "Environment Variables"
3. Add:
   - Key: `PDF_SERVICE_API_KEY`
   - Value: `your_production_api_key`
   - Environment: Production (and Preview if needed)
4. Redeploy your application

## How It Works

### Files Involved

1. **API Route**: `/src/app/api/proxy-pdf/route.ts`
   - Handles GET requests with `fileId` parameter
   - Reads `PDF_SERVICE_API_KEY` from environment
   - Fetches PDF from backend with API key appended
   - Streams PDF back to client

2. **Component**: `/src/components/jobs/BulkApplyBar.tsx`
   - `getProxyPdfUrl()` helper function extracts `fileId` from backend URL
   - Iframe uses proxy URL: `/api/proxy-pdf?fileId=XXX`
   - Download/Open buttons also use proxy URL

### Code Example

```typescript
// Helper function in BulkApplyBar.tsx
function getProxyPdfUrl(pdfDownloadUrl: string): string {
  const url = new URL(pdfDownloadUrl);
  const fileId = url.searchParams.get('fileId');
  return `/api/proxy-pdf?fileId=${fileId}`;
}

// Usage in iframe
<iframe
  src={getProxyPdfUrl(resume.pdfDownloadUrl)}
  className="w-full h-full"
  title="Resume Preview"
/>
```

## Security Benefits

✅ **API Key Protection**: API key never exposed to client-side code  
✅ **No Browser Visibility**: API key not visible in DevTools or network requests  
✅ **Server-Side Only**: Environment variable only accessible on Next.js server  
✅ **Centralized Control**: Single point to manage PDF access  
✅ **Future-Proof**: Easy to add authentication/authorization later  

## Troubleshooting

### PDF Not Loading

**Problem**: Iframe shows blank or error message

**Solutions**:
1. Check if `PDF_SERVICE_API_KEY` is set in `.env.local`
2. Restart the Next.js development server
3. Check browser console for errors
4. Verify backend service is running

### "PDF service is not configured" Error

**Problem**: API route returns 500 error

**Solution**: The `PDF_SERVICE_API_KEY` environment variable is missing. Add it to `.env.local` and restart the server.

### Backend Returns 404

**Problem**: PDF not found error from backend

**Solutions**:
1. Verify the `fileId` is correct
2. Check if the resume was successfully generated
3. Verify backend service is accessible

### API Key Still Exposed

**Problem**: API key visible in browser

**Solution**: Make sure the environment variable is **NOT** prefixed with `NEXT_PUBLIC_`. Only server-side variables (without the prefix) remain private.

## Additional Notes

- The proxy route caches PDFs for 1 hour (`Cache-Control: public, max-age=3600`)
- PDFs are streamed (not buffered) to handle large files efficiently
- The route handles errors gracefully with appropriate HTTP status codes
- File naming convention: `resume-{fileId}.pdf`

## Support

For issues or questions, check:
1. Next.js environment variables documentation
2. Backend service logs for PDF generation errors
3. Browser DevTools console and network tab for client-side errors




